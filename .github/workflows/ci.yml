on:
  push:
    branches:
      - master

jobs:
  build-mac:
    name: Mac executable
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3
      - uses: dtolnay/rust-toolchain@stable
      - run: cargo build --release --all-features
      - name: 'Upload Artifact'
        uses: actions/upload-artifact@v2
        with:
          name: directory-packages-props-converter-mac
          path: target/release/directory-packages-props-converter

  build-windows:
    name: Windows executable
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
      - uses: dtolnay/rust-toolchain@stable
      - run: cargo build --release --all-features
      - name: 'Upload Artifact'
        uses: actions/upload-artifact@v2
        with:
          name: directory-packages-props-converter-win.exe
          path: target/release/directory-packages-props-converter.exe

  release:
      name: Release
      runs-on: ubuntu-latest
      needs: [build-mac, build-windows]
      steps:
        - uses: actions/checkout@v3
          with:
            fetch-depth: 0
        
        - name: Get version from CHANGELOG.md
          id: changelog_reader
          uses: mindsers/changelog-reader-action@v2
          with:
            path: ./CHANGELOG.md

        - name: Push a tag
          id: push_tag
          uses: mathieudutour/github-tag-action@v6
          with:
            github_token: ${{ secrets.GITHUB_TOKEN }}
            custom_tag: ${{ steps.changelog_reader.outputs.version }}
            release_branches: master

        - name: Create Release
          id: create_release
          uses: actions/create-release@v1.1.2
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          with:
            tag_name: v${{ steps.changelog_reader.outputs.version }}
            release_name: ${{ steps.changelog_reader.outputs.version }}
            body: ${{ steps.changelog_reader.outputs.changes }}
            prerelease: ${{ steps.changelog_reader.outputs.status == 'prereleased' }}
            draft: false

        - uses: actions/download-artifact@v3
          with:
            name: directory-packages-props-converter-mac

        - uses: actions/download-artifact@v3
          with:
            name: directory-packages-props-converter-win.exe

        - name: Upload Windows Release Asset
          uses: actions/upload-release-asset@v1
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          with:
            upload_url: ${{ steps.create_release.outputs.upload_url }}
            asset_path: ./directory-packages-props-converter-win.exe
            asset_name: directory-packages-props-converter.exe
            asset_content_type: application/executable

        - name: Upload Mac Release Asset
          uses: actions/upload-release-asset@v1
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          with:
            upload_url: ${{ steps.create_release.outputs.upload_url }}
            asset_path: ./directory-packages-props-converter-mac
            asset_name: directory-packages-props-converter
            asset_content_type: application/executable